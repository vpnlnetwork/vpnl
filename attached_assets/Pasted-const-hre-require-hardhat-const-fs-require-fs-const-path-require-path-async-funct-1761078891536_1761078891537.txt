const hre = require(â€œhardhatâ€);
const fs = require(â€œfsâ€);
const path = require(â€œpathâ€);

async function main() {
const networkName = hre.network.name;
console.log(`\nğŸ§ª Creating test data on ${networkName}...`);
console.log(â€==========================================\nâ€);

// Load deployment info
const deploymentFile = path.join(__dirname, â€œ..â€, â€œdeploymentsâ€, `${networkName}.json`);

if (!fs.existsSync(deploymentFile)) {
console.error(â€œâŒ Deployment file not found!â€);
console.error(`   Expected: ${deploymentFile}`);
console.error(â€   Please run deployment first: npm run deploy:sepoliaâ€);
process.exit(1);
}

const deploymentInfo = JSON.parse(fs.readFileSync(deploymentFile, â€œutf8â€));
const registryAddress = deploymentInfo.registry;

console.log(â€œğŸ“‹ Configuration:â€);
console.log(â€  Network:â€, networkName);
console.log(â€  Registry:â€, registryAddress);
console.log();

const registry = await hre.ethers.getContractAt(â€œVPNLRegistryâ€, registryAddress);
const [signer] = await hre.ethers.getSigners();

// Verify weâ€™re the verifier
const verifier = await registry.verifier();
if (verifier.toLowerCase() !== signer.address.toLowerCase()) {
console.error(â€œâŒ Only the verifier can create test data!â€);
console.error(`   Current verifier: ${verifier}`);
console.error(`   Your address: ${signer.address}`);
process.exit(1);
}

// Mock solver addresses - using deterministic addresses for consistency
const mockSolvers = [
{
address: â€œ0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb1â€,
name: â€œExpert Solver Alphaâ€,
score: 0.85,
tier: â€œExpertâ€,
specialties: [â€œcross-chainâ€, â€œhigh-volumeâ€]
},
{
address: â€œ0x5c6B0f7Bf3E7ce046039Bd8FABdfD3f9F5021678â€,
name: â€œAdvanced Solver Betaâ€,
score: 0.65,
tier: â€œAdvancedâ€,
specialties: [â€œlow-latencyâ€]
},
{
address: â€œ0x03C6FcED478cde53Abb47b5dC3Bb8B3c1f2A0C2Fâ€,
name: â€œEmerging Solver Gammaâ€,
score: 0.30,
tier: â€œEmergingâ€,
specialties: []
},
{
address: â€œ0x1234567890AbcdEF1234567890aBcdef12345678â€,
name: â€œExpert Solver Deltaâ€,
score: 0.92,
tier: â€œExpertâ€,
specialties: [â€œexotic-pairsâ€, â€œcross-chainâ€]
},
];

console.log(â€œğŸ”¨ Creating verifications for mock solversâ€¦\nâ€);

const testDataResults = [];

for (const solver of mockSolvers) {
console.log(`Processing: ${solver.name}`);
console.log(`  Address: ${solver.address}`);
console.log(`  Score: ${solver.score} (${solver.tier})`);

```
// Check if already verified
const existingVerification = await registry.getVerification(solver.address);
if (existingVerification.active) {
  console.log(`  âš ï¸  Already verified - skipping`);
  console.log();
  continue;
}

// Generate commitment hash
// commitment = keccak256(abi.encode(score, salt, metadata))
const scoreScaled = Math.floor(solver.score * 1000); // Scale to 0-1000
const salt = hre.ethers.randomBytes(32);
const metadata = hre.ethers.encodeBytes32String(solver.tier);

const commitment = hre.ethers.keccak256(
  hre.ethers.AbiCoder.defaultAbiCoder().encode(
    ["uint256", "bytes32", "bytes32"],
    [scoreScaled, salt, metadata]
  )
);

// Set expiration to 180 days from now
const currentTime = Math.floor(Date.now() / 1000);
const expiresAt = currentTime + (180 * 24 * 60 * 60);

console.log(`  Commitment: ${commitment.slice(0, 10)}...`);

try {
  const tx = await registry.verify(solver.address, commitment, expiresAt);
  console.log(`  Transaction: ${tx.hash}`);
  
  const receipt = await tx.wait();
  console.log(`  âœ… Verified in block ${receipt.blockNumber}`);
  console.log(`  Gas used: ${receipt.gasUsed.toString()}`);

  testDataResults.push({
    solver: solver.address,
    name: solver.name,
    tier: solver.tier,
    score: solver.score,
    commitment: commitment,
    transactionHash: tx.hash,
    blockNumber: receipt.blockNumber,
    expiresAt: new Date(expiresAt * 1000).toISOString(),
  });
} catch (error) {
  console.log(`  âŒ Failed: ${error.message}`);
}

console.log();
```

}

// Save test data info
const testDataFile = path.join(__dirname, â€œ..â€, â€œdeploymentsâ€, `${networkName}-testdata.json`);
fs.writeFileSync(
testDataFile,
JSON.stringify({
network: networkName,
registry: registryAddress,
createdAt: new Date().toISOString(),
solvers: testDataResults,
}, null, 2)
);

console.log(â€œğŸ’¾ Test data info saved to:â€, testDataFile);
console.log();

console.log(â€œâœ¨ Test data creation complete!â€);
console.log();
console.log(â€œğŸ“‹ Summary:â€);
console.log(`  Created: ${testDataResults.length} verifications`);
console.log(`  Registry: ${registryAddress}`);
console.log(`  Explorer: ${deploymentInfo.explorerUrl}`);
console.log();
console.log(â€œğŸ”— Test these addresses in your frontend:â€);
testDataResults.forEach(r => {
console.log(`  ${r.name}: ${r.solver}`);
});
console.log();
}

main()
.then(() => process.exit(0))
.catch((error) => {
console.error(â€œâŒ Test data creation failed:â€);
console.error(error);
process.exit(1);
});