const hre = require(â€œhardhatâ€);
const fs = require(â€œfsâ€);
const path = require(â€œpathâ€);

async function main() {
const networkName = hre.network.name;
console.log(`\nğŸš€ Deploying VPNLRegistry to ${networkName}...`);
console.log(â€==========================================\nâ€);

const [deployer] = await hre.ethers.getSigners();
const balance = await hre.ethers.provider.getBalance(deployer.address);

console.log(â€œğŸ“‹ Deployment Configuration:â€);
console.log(â€  Deployer address:â€, deployer.address);
console.log(â€  Account balance:â€, hre.ethers.formatEther(balance), â€œETHâ€);
console.log(â€  Network:â€, networkName);
console.log(â€  Chain ID:â€, (await hre.ethers.provider.getNetwork()).chainId);
console.log();

// Verify sufficient balance
if (balance < hre.ethers.parseEther(â€œ0.01â€)) {
console.error(â€œâŒ Insufficient balance for deployment!â€);
console.error(â€   Please fund your address with testnet ETHâ€);
console.error(â€   Arbitrum Sepolia Faucet: https://faucet.quicknode.com/arbitrum/sepoliaâ€);
process.exit(1);
}

// Deploy VPNLRegistry
console.log(â€œğŸ“¦ Deploying VPNLRegistry contractâ€¦â€);
const VPNLRegistry = await hre.ethers.getContractFactory(â€œVPNLRegistryâ€);

// Use deployer as initial verifier (can be changed later via updateVerifier)
const verifier = deployer.address;

const registry = await VPNLRegistry.deploy(verifier);
await registry.waitForDeployment();

const registryAddress = await registry.getAddress();
const deploymentTx = registry.deploymentTransaction();

console.log(â€œâœ… VPNLRegistry deployed successfully!â€);
console.log();
console.log(â€œğŸ“ Contract Details:â€);
console.log(â€  Registry address:â€, registryAddress);
console.log(â€  Verifier address:â€, verifier);
console.log(â€  Deployment tx:â€, deploymentTx.hash);
console.log(â€  Block number:â€, (await deploymentTx.wait()).blockNumber);
console.log();

// Save deployment information
const deploymentsDir = path.join(__dirname, â€œ..â€, â€œdeploymentsâ€);
if (!fs.existsSync(deploymentsDir)) {
fs.mkdirSync(deploymentsDir, { recursive: true });
}

const deploymentInfo = {
network: networkName,
chainId: Number((await hre.ethers.provider.getNetwork()).chainId),
registry: registryAddress,
verifier: verifier,
deployer: deployer.address,
deploymentTx: deploymentTx.hash,
blockNumber: (await deploymentTx.wait()).blockNumber,
timestamp: new Date().toISOString(),
explorerUrl: networkName === â€œarbitrumSepoliaâ€
? `https://sepolia.arbiscan.io/address/${registryAddress}`
: `https://arbiscan.io/address/${registryAddress}`,
};

const deploymentFile = path.join(deploymentsDir, `${networkName}.json`);
fs.writeFileSync(deploymentFile, JSON.stringify(deploymentInfo, null, 2));

console.log(â€œğŸ’¾ Deployment info saved to:â€, deploymentFile);
console.log();

// Wait for block confirmations before verification
console.log(â€œâ³ Waiting for 5 block confirmations before verificationâ€¦â€);
await deploymentTx.wait(5);
console.log(â€œâœ… Confirmations complete!â€);
console.log();

// Verify contract on Etherscan/Arbiscan
console.log(â€œğŸ” Verifying contract on block explorerâ€¦â€);
try {
await hre.run(â€œverify:verifyâ€, {
address: registryAddress,
constructorArguments: [verifier],
});
console.log(â€œâœ… Contract verified successfully!â€);
console.log();
} catch (error) {
if (error.message.includes(â€œAlready Verifiedâ€)) {
console.log(â€œâ„¹ï¸  Contract already verifiedâ€);
console.log();
} else {
console.log(â€œâš ï¸  Verification failed:â€, error.message);
console.log();
console.log(â€œğŸ“ Manual verification command:â€);
console.log(`   npx hardhat verify --network ${networkName} ${registryAddress} ${verifier}`);
console.log();
}
}

// Display explorer links
console.log(â€œğŸ”— Explorer Links:â€);
console.log(â€  Contract:â€, deploymentInfo.explorerUrl);
console.log(â€  Transaction:â€,
networkName === â€œarbitrumSepoliaâ€
? `https://sepolia.arbiscan.io/tx/${deploymentTx.hash}`
: `https://arbiscan.io/tx/${deploymentTx.hash}`
);
console.log();

console.log(â€œâœ¨ Deployment complete!â€);
console.log();
console.log(â€œğŸ“‹ Next steps:â€);
console.log(â€  1. Save the deployment info from:â€, deploymentFile);
console.log(â€  2. Create test verifications: npm run populate:testdataâ€);
console.log(â€  3. Update DEMO.md with contract addressesâ€);
console.log(â€  4. Test queries using the frontend demoâ€);
console.log();
}

main()
.then(() => process.exit(0))
.catch((error) => {
console.error(â€œâŒ Deployment failed:â€);
console.error(error);
process.exit(1);
});