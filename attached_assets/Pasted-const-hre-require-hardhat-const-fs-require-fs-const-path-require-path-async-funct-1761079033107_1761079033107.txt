const hre = require(â€œhardhatâ€);
const fs = require(â€œfsâ€);
const path = require(â€œpathâ€);

async function main() {
console.log(â€\nğŸ” VPNL Deployment Setup Verificationâ€);
console.log(â€=====================================\nâ€);

let errors = [];
let warnings = [];
let checks = 0;
let passed = 0;

// Check 1: Node version
checks++;
console.log(â€œ1ï¸âƒ£  Checking Node.js versionâ€¦â€);
const nodeVersion = process.version;
const majorVersion = parseInt(nodeVersion.split(â€™.â€™)[0].replace(â€˜vâ€™, â€˜â€™));
if (majorVersion >= 18) {
console.log(`   âœ… Node.js ${nodeVersion} (>= v18 required)\n`);
passed++;
} else {
console.log(`   âŒ Node.js ${nodeVersion} (v18+ required)\n`);
errors.push(â€œUpdate Node.js to v18 or higherâ€);
}

// Check 2: .env file exists
checks++;
console.log(â€œ2ï¸âƒ£  Checking .env configurationâ€¦â€);
const envPath = path.join(__dirname, â€œ..â€, â€œ.envâ€);
if (fs.existsSync(envPath)) {
console.log(â€   âœ… .env file exists\nâ€);
passed++;
} else {
console.log(â€   âŒ .env file not found\nâ€);
errors.push(â€œCreate .env file: cp .env.example .envâ€);
}

// Check 3: Required environment variables
checks++;
console.log(â€œ3ï¸âƒ£  Checking environment variablesâ€¦â€);
const requiredVars = [â€œPRIVATE_KEYâ€, â€œETHERSCAN_API_KEYâ€];
let allVarsPresent = true;

for (const varName of requiredVars) {
if (process.env[varName]) {
console.log(`   âœ… ${varName} is set`);
} else {
console.log(`   âŒ ${varName} is missing`);
allVarsPresent = false;
errors.push(`Add ${varName} to .env file`);
}
}
console.log();
if (allVarsPresent) passed++;

// Check 4: Private key format
checks++;
console.log(â€œ4ï¸âƒ£  Validating private key formatâ€¦â€);
if (process.env.PRIVATE_KEY) {
const pk = process.env.PRIVATE_KEY;
if (pk.startsWith(â€œ0xâ€)) {
console.log(â€   âš ï¸  Private key has 0x prefix (should be removed)\nâ€);
warnings.push(â€œRemove 0x prefix from PRIVATE_KEY in .envâ€);
} else if (pk.length === 64 && /^[a-fA-F0-9]+$/.test(pk)) {
console.log(â€   âœ… Private key format is valid\nâ€);
passed++;
} else {
console.log(â€   âŒ Private key format is invalid\nâ€);
errors.push(â€œPrivate key must be 64 hexadecimal charactersâ€);
}
} else {
console.log(â€   â­ï¸  Skipped (no private key set)\nâ€);
}

// Check 5: Network connectivity
checks++;
console.log(â€œ5ï¸âƒ£  Testing Arbitrum Sepolia RPC connectionâ€¦â€);
try {
const provider = new hre.ethers.JsonRpcProvider(
process.env.ARBITRUM_SEPOLIA_RPC_URL || â€œhttps://sepolia-rollup.arbitrum.io/rpcâ€
);
const blockNumber = await provider.getBlockNumber();
console.log(`   âœ… Connected! Current block: ${blockNumber}\n`);
passed++;
} catch (error) {
console.log(`   âŒ Connection failed: ${error.message}\n`);
errors.push(â€œCheck ARBITRUM_SEPOLIA_RPC_URL or network connectionâ€);
}

// Check 6: Wallet balance
checks++;
console.log(â€œ6ï¸âƒ£  Checking wallet balanceâ€¦â€);
if (process.env.PRIVATE_KEY) {
try {
const [signer] = await hre.ethers.getSigners();
const address = signer.address;
const balance = await hre.ethers.provider.getBalance(address);
const balanceEth = hre.ethers.formatEther(balance);

```
  console.log(`   Address: ${address}`);
  console.log(`   Balance: ${balanceEth} ETH`);

  if (parseFloat(balanceEth) >= 0.01) {
    console.log("   âœ… Sufficient balance for deployment\n");
    passed++;
  } else {
    console.log("   âš ï¸  Low balance (need ~0.05 ETH recommended)\n");
    warnings.push("Get testnet ETH from: https://faucet.quicknode.com/arbitrum/sepolia");
    passed++;
  }
} catch (error) {
  console.log(`   âŒ Failed to check balance: ${error.message}\n`);
  errors.push("Verify private key is correct");
}
```

} else {
console.log(â€   â­ï¸  Skipped (no private key set)\nâ€);
}

// Check 7: Contracts compile
checks++;
console.log(â€œ7ï¸âƒ£  Compiling smart contractsâ€¦â€);
try {
await hre.run(â€œcompileâ€);
console.log(â€   âœ… Contracts compiled successfully\nâ€);
passed++;
} catch (error) {
console.log(`   âŒ Compilation failed: ${error.message}\n`);
errors.push(â€œFix contract compilation errorsâ€);
}

// Check 8: Git repository status
checks++;
console.log(â€œ8ï¸âƒ£  Checking Git repositoryâ€¦â€);
try {
const { execSync } = require(â€˜child_processâ€™);
execSync(â€˜git rev-parse â€“git-dirâ€™, { stdio: â€˜ignoreâ€™ });

```
// Check if .env is gitignored
try {
  execSync('git check-ignore .env', { stdio: 'ignore' });
  console.log("   âœ… Git repository found");
  console.log("   âœ… .env file is properly gitignored\n");
  passed++;
} catch (e) {
  console.log("   âœ… Git repository found");
  console.log("   âš ï¸  .env file might not be gitignored!\n");
  warnings.push("Ensure .env is in .gitignore to prevent committing secrets");
  passed++;
}
```

} catch (error) {
console.log(â€   âš ï¸  Not a Git repository (optional)\nâ€);
passed++;
}

// Check 9: Required directories
checks++;
console.log(â€œ9ï¸âƒ£  Checking directory structureâ€¦â€);
const requiredDirs = [â€œcontractsâ€, â€œscriptsâ€];
let allDirsPresent = true;

for (const dir of requiredDirs) {
const dirPath = path.join(__dirname, â€œ..â€, dir);
if (fs.existsSync(dirPath)) {
console.log(`   âœ… ${dir}/ directory exists`);
} else {
console.log(`   âŒ ${dir}/ directory missing`);
allDirsPresent = false;
errors.push(`Create ${dir}/ directory`);
}
}
console.log();
if (allDirsPresent) passed++;

// Check 10: Contract file exists
checks++;
console.log(â€œğŸ”Ÿ Checking VPNLRegistry.solâ€¦â€);
const contractPath = path.join(__dirname, â€œ..â€, â€œcontractsâ€, â€œVPNLRegistry.solâ€);
if (fs.existsSync(contractPath)) {
console.log(â€   âœ… VPNLRegistry.sol found\nâ€);
passed++;
} else {
console.log(â€   âŒ VPNLRegistry.sol not found\nâ€);
errors.push(â€œEnsure VPNLRegistry.sol is in contracts/ directoryâ€);
}

// Summary
console.log(â€=====================================â€);
console.log(â€œğŸ“Š SUMMARYâ€);
console.log(â€=====================================\nâ€);

console.log(`Checks completed: ${passed}/${checks}`);
console.log();

if (warnings.length > 0) {
console.log(â€œâš ï¸  WARNINGS:â€);
warnings.forEach((warning, i) => {
console.log(`  ${i + 1}. ${warning}`);
});
console.log();
}

if (errors.length > 0) {
console.log(â€œâŒ ERRORS (must fix before deployment):â€);
errors.forEach((error, i) => {
console.log(`  ${i + 1}. ${error}`);
});
console.log();
console.log(â€œğŸ”§ Fix these issues and run: npm run verify:setup\nâ€);
process.exit(1);
} else if (warnings.length > 0) {
console.log(â€œâœ… Setup is valid but has warningsâ€);
console.log(â€œğŸ’¡ Review warnings above before deployment\nâ€);
console.log(â€œReady to deploy? Run: npm run deploy:sepolia\nâ€);
process.exit(0);
} else {
console.log(â€œâœ… All checks passed! Setup is complete.\nâ€);
console.log(â€œğŸš€ Ready to deploy? Run: npm run deploy:sepolia\nâ€);
process.exit(0);
}
}

main()
.catch((error) => {
console.error(â€\nâŒ Verification failed:â€);
console.error(error);
process.exit(1);
});